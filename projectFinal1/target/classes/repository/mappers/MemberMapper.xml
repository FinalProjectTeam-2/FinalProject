<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.finalproject.festival.mapper.MemberMapper" >

	<select id="userCheck" resultType="Member"  >
		SELECT * From Member WHERE id = #{id} OR email = #{email}
	</select>
	
	<select id="userCount" resultType="Integer"  >
		SELECT COUNT(*)  From Member WHERE id = #{id} OR email = #{email}
	</select>
	
	<select id="userFindId" resultType="Integer" parameterType="hashMap">
		SELECT COUNT(*) FROM Member WHERE name = #{name} AND email = #{email}	
	</select>
	
	<select id="userFindPassword" resultType="Integer" parameterType="hashMap">
		SELECT COUNT(*) FROM Member WHERE id = #{id} AND email = #{email}	
	</select>
	
	<select id="userLoginCount" resultType="Integer" >
		SELECT COUNT(*) 
    FROM (
        SELECT 'Member' AS userType, id, name, phonenumber, email, totalpay, grade, password
        FROM Member
        WHERE id = #{id}
        UNION ALL
        SELECT 'Admin' AS userType, adminid AS id, adminname AS name, NULL AS phonenumber, NULL AS email, NULL AS totalpay, NULL AS grade, adminpassword AS password
        FROM Admin
        WHERE adminid = #{id}
        ) AS UserCount;
		
	</select>
	
	<select id="userLogin" resultType="hashMap" >
		 SELECT 'Member' AS userType, id, name, phonenumber, email, totalpay, grade, password
	    FROM Member
	    WHERE id = #{id}
	    UNION ALL
	    SELECT 'Admin' AS userType, adminid AS id, adminname AS name, NULL AS phonenumber, NULL AS email, NULL AS totalpay, NULL AS grade, adminpassword AS password
	    FROM Admin
	    WHERE adminid = #{id}
		
	</select>

	<insert id="joinMember" parameterType="Member">
		INSERT INTO Member (name, id, phonenumber, password, zipcode,address1,address2,email,joindate,totalpay,grade) 
					VALUES(#{name},#{id},#{phonenumber},#{password},#{zipcode},
									#{address1},#{address2},#{email},SYSDATE(),0,0)
	</insert>
	
	<insert id="newMemberCoupon" parameterType="String">
		INSERT INTO MemberCoupon (couponno,id,couponopendate,couponclosedate)
						VALUES(1,#{id},SYSDATE(),DATE_ADD(SYSDATE(), INTERVAL 7 DAY)) 
	</insert>
	
	<update id="userNewPassword"  parameterType="hashMap" >
    	UPDATE Member SET password = #{password} WHERE id = #{id}
	</update>
	
	
	
				<!--************** admin ****************-->
	
	<select id="adminUserSelect" resultType="Admin">
		SELECT * FROM Admin;
	</select>
	
	<insert id="adminUserAdd" parameterType="hashMap">
	INSERT INTO Admin (adminname,adminid,adminpassword) 
					VALUES(#{adminname},#{adminid},#{adminpassword})
	</insert>
	
	
	
				<!--************** main ****************-->		
				
	<!-- Combined resultMap -->
	<resultMap id="combinedResultMap" type="java.util.HashMap">
	    <result property="tableName" column="table_name"/>
	    <result property="itemTitle" column="item_title"/>
	    <result property="itemContent" column="item_content"/>
	    <result property="itemImg" column="item_img"/>
	    <result property="itemNo" column="item_no"/>
	    <result property="itemId" column="item_id"/>
	    <result property="itemPrice" column="item_price"/>
	</resultMap>
				
	<select id="mainProductCarousel" resultType="Product">
		SELECT * FROM Product ORDER BY productbookmarkcount DESC
	</select>	
	
	<select id="mainSearchPage" resultMap="combinedResultMap" resultType="Main">
		 SELECT
		    'Product' AS table_name,
		    productname AS item_title,
		    productcontent AS item_content,
		    productimage AS item_img,
		    productno AS item_no,
		    NULL AS item_id,
		    productprice AS item_price
		    
		FROM
		    Product
		WHERE
		    productname LIKE CONCAT('%', #{keyword}, '%') OR
		    productcontent LIKE CONCAT('%', #{keyword}, '%') 
		
		UNION
		
		SELECT
		    'Gallery' AS table_name,
		    gallerytitle AS item_title,
		    gallerycontent AS item_content,
		    galleryimage AS item_img,
			galleryno AS item_no,
		    id AS item_id,
		   NULL AS item_price
		FROM
		    Gallery
		WHERE
		    gallerytitle LIKE CONCAT('%', #{keyword}, '%') OR
		    gallerycontent LIKE CONCAT('%', #{keyword}, '%') 
		
		UNION
		
		SELECT
		    'News' AS table_name,
		    newstitle AS item_title,
		    newscontent AS item_content,
		    newsimage AS item_img,
		    newsno AS item_no,
		    NULL AS item_id,
		    NULL AS item_price 
		   
		FROM
		    News
		WHERE
		    newstitle LIKE CONCAT('%', #{keyword}, '%') OR
		    newscontent LIKE CONCAT('%', #{keyword}, '%') 
</select>	
	
</mapper>	



